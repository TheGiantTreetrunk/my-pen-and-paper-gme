<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rosebud Game Sync Tester</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1000px; }
        .card { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 20px; width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h2 { color: #4CAF50; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #252525; padding: 8px; border-radius: 4px; font-size: 0.9em; }
        .stat-label { color: #888; display: block; font-size: 0.8em; }
        button { background: #388E3C; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; transition: background 0.2s; margin-top: 5px; }
        button:hover { background: #45a049; }
        .sync-btn { background: #1976D2; }
        .sync-btn:hover { background: #1e88e5; }
        #log { width: 100%; max-width: 660px; background: #000; color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; margin-top: 20px; height: 150px; overflow-y: auto; font-size: 0.85em; }
    </style>
</head>
<body>

    <h1>Rosebud Firebase Sync</h1>

    <div class="container">
        <div class="card">
            <h2>Player Stats</h2>
            <div id="rosebud_ui_stats" class="stat-grid">
                </div>
            <button onclick="simulateGameAction()">Find Gold & Loot (+10)</button>
            <button onclick="rosebud_change_name()" style="background: #7b1fa2;">Change Name</button>
        </div>

        <div class="card">
            <h2>Cloud Sync</h2>
            <p id="rosebud_ui_username">User: Loading...</p>
            <p style="font-size: 0.8em; color: #888;">UID: <span id="rosebud_ui_uid">---</span></p>
            <button class="sync-btn" onclick="triggerManualSync()">Manual Cloud Save</button>
            <button onclick="refreshLeaderboard()" style="background: #f57c00;">Show Top Players</button>
        </div>
    </div>

    <div id="log">Initializing Rosebud Firebase System...<br></div>

    <script type="module">
        // Firebase Browser SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. YOUR PLAYER OBJECT
        window.player = {
            icon: "@", health: 10, academic: 10, mobility: 10, strength: 10,
            armor: 0, shield: 0, weapon: 1, class: 0, gold: 0, food: 0,
            potion: 0, arrows: 0, bullets: 0, scrolls: 0, water: 0
        };

        // 2. FIREBASE SYSTEM CLASS
        class RosebudFirebaseSystem {
            constructor(config) {
                this.rosebud_firebase_app = initializeApp(config);
                this.rosebud_firebase_auth = getAuth(this.rosebud_firebase_app);
                this.rosebud_firebase_db = getFirestore(this.rosebud_firebase_app);
                this.rosebud_firebase_username = "Guest";
                this.rosebud_firebase_init_auth();
            }

            rosebud_firebase_init_auth() {
                onAuthStateChanged(this.rosebud_firebase_auth, async (user) => {
                    if (user) {
                        logToScreen(`Authenticated: ${user.uid}`);
                        document.getElementById('rosebud_ui_uid').innerText = user.uid.substring(0,8) + "...";
                        
                        const cloudData = await this.rosebud_firebase_fetch_data(user.uid);
                        
                        // Merge cloud data into your local player object
                        if (cloudData) {
                            this.rosebud_firebase_username = cloudData.username || "Guest";
                            // Separate username from the rest of the stats for the player object
                            const { username, ...stats } = cloudData;
                            Object.assign(window.player, stats);
                        }
                        
                        updateLocalUI();
                    } else {
                        await signInAnonymously(this.rosebud_firebase_auth);
                    }
                });
            }

            async rosebud_firebase_fetch_data(uid) {
                const ref = doc(this.rosebud_firebase_db, "users", uid);
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    logToScreen("Cloud data found and synced.");
                    return snap.data();
                } else {
                    logToScreen("No cloud data. Creating new profile...");
                    const defaultProfile = { username: "Guest_" + Math.floor(Math.random()*999), ...window.player };
                    await setDoc(ref, defaultProfile);
                    return defaultProfile;
                }
            }

            async rosebud_firebase_save_all() {
                const user = this.rosebud_firebase_auth.currentUser;
                if (!user) return;
                logToScreen("Saving to cloud...");
                const ref = doc(this.rosebud_firebase_db, "users", user.uid);
                await updateDoc(ref, { 
                    ...window.player, 
                    username: this.rosebud_firebase_username,
                    score: window.player.gold // Using gold as the leaderboard score
                });
                logToScreen("Save Complete âœ…");
            }

            async rosebud_firebase_set_name(newName) {
                this.rosebud_firebase_username = newName;
                await this.rosebud_firebase_save_all();
                updateLocalUI();
            }
        }

        // 3. INITIALIZE
        const rosebud_firebase_config = {
            apiKey: "AIzaSyAB-HTTSt2MziITzzi9PUlLAK7J8OvVkoM",
            authDomain: "rage-n-riches.firebaseapp.com",
            projectId: "rage-n-riches",
            storageBucket: "rage-n-riches.firebasestorage.app",
            messagingSenderId: "809289464798",
            appId: "1:809289464798:web:0abff20ca2629d29927b4f",
            measurementId: "G-HE4CTRS5DW"
        };

        const Rosebud = new RosebudFirebaseSystem(rosebud_firebase_config);

        // 4. UI & INTERACTION HELPERS
        function updateLocalUI() {
            const statsContainer = document.getElementById('rosebud_ui_stats');
            statsContainer.innerHTML = '';
            
            for (const [key, value] of Object.entries(window.player)) {
                statsContainer.innerHTML += `
                    <div class="stat-item">
                        <span class="stat-label">${key.toUpperCase()}</span>
                        <b>${value}</b>
                    </div>`;
            }
            document.getElementById('rosebud_ui_username').innerText = `User: ${Rosebud.rosebud_firebase_username}`;
        }

        window.simulateGameAction = () => {
            window.player.gold += 10;
            window.player.food += 1;
            logToScreen("Action: Found +10 Gold and +1 Food.");
            updateLocalUI();
        };

        window.triggerManualSync = () => Rosebud.rosebud_firebase_save_all();

        window.rosebud_change_name = () => {
            const name = prompt("Enter new name:");
            if (name) Rosebud.rosebud_firebase_set_name(name);
        };

        function logToScreen(msg) {
            const log = document.getElementById('log');
            log.innerHTML += `> ${msg}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        // Initialize display
        updateLocalUI();
    </script>
</body>
</html>